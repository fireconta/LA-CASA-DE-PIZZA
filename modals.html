<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Estilos dos modals */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            width: 300px;
            max-width: 90%;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal.active {
            display: block;
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        .modal-content {
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1rem;
            color: #4b5563;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #dc2626;
        }
        .modal h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .modal p {
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 0.75rem;
        }
        .modal select,
        .modal input {
            margin-top: 0.5rem;
            display: block;
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem;
            background: #f9fafb;
            color: #1f2937;
            font-size: 0.875rem;
        }
        .modal select:focus,
        .modal input:focus {
            outline: none;
            border-color: #16a34a;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.2);
        }
        .modal button {
            margin-top: 0.75rem;
            width: 100%;
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .modal button:hover {
            background: linear-gradient(135deg, #15803d, #16a34a);
        }
        .modal button.secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }
        .modal button.secondary:hover {
            background: linear-gradient(135deg, #4b5563, #6b7280);
        }
        .error-message {
            display: none;
            color: #dc2626;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.5rem;
            text-align: center;
            background-color: #fee2e2;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .error-message.visible {
            display: block;
        }
        .modal-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .modal-buttons button {
            flex: 1;
        }
        .flavor-selections {
            margin: 1rem 0;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 0.5rem;
        }
        .flavor-selections label {
            display: block;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        .flavor-selections select {
            margin-bottom: 1rem;
            border: 2px solid #e5e7eb;
            transition: border-color 0.2s;
        }
        .flavor-selections select:focus {
            border-color: #16a34a;
        }
        #flavor-progress {
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 0.75rem;
        }

        /* Estilos do carrinho */
        #cart {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 360px;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        #cart.active {
            display: block;
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        #cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        #cart-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #dc2626;
        }
        #cart-header button {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: #4b5563;
            cursor: pointer;
            transition: color 0.2s;
        }
        #cart-header button:hover {
            color: #dc2626;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-item-details {
            flex-grow: 1;
        }
        .cart-item span {
            font-size: 0.875rem;
            color: #4b5563;
            display: block;
        }
        .quantity-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .quantity-btn {
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }
        .quantity-btn:hover {
            background: linear-gradient(135deg, #15803d, #16a34a);
        }
        .remove-from-cart {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .remove-from-cart:hover {
            background: linear-gradient(135deg, #b91c1c, #dc2626);
        }
        #cart-total {
            font-size: 1.125rem;
            font-weight: 700;
            color: #dc2626;
            margin-top: 1.25rem;
            text-align: right;
        }
        #cart-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.25rem;
        }
        #clear-cart-btn, #checkout-btn {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: transform 0.2s, background 0.2s;
        }
        #clear-cart-btn {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }
        #clear-cart-btn:hover {
            transform: scale(1.05);
            background: linear-gradient(135deg, #4b5563, #6b7280);
        }
        #checkout-btn {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
        }
        #checkout-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        #checkout-btn:hover:not(:disabled) {
            transform: scale(1.05);
            background: linear-gradient(135deg, #1d4ed8, #2563eb);
        }
        #minimum-order-message {
            display: none;
            color: #dc2626;
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.75rem;
            text-align: center;
        }
        #minimum-order-message.visible {
            display: block;
        }

        @media (max-width: 640px) {
            #cart {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <!-- Modal de Seleção de Estado -->
    <div id="state-modal" class="modal" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="window.parent.postMessage({ action: 'hideModal', modalId: 'state-modal' }, '*')" aria-label="Fechar modal de estado">✖</button>
            <h2>Escolha seu Estado</h2>
            <p>Selecione o estado onde você está localizado:</p>
            <select id="state-select" aria-label="Selecione seu estado">
                <option value="">Carregando estados...</option>
            </select>
            <p id="state-error" class="error-message"></p>
            <button id="next-state-btn" onclick="window.parent.postMessage({ action: 'showCityModal' }, '*')" aria-label="Próximo passo">Próximo</button>
        </div>
    </div>

    <!-- Modal de Seleção de Cidade -->
    <div id="city-modal" class="modal" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="window.parent.postMessage({ action: 'hideModal', modalId: 'city-modal' }, '*')" aria-label="Fechar modal de cidade">✖</button>
            <h2>Escolha sua Cidade</h2>
            <p>Selecione a cidade mais próxima de você:</p>
            <select id="city-select" aria-label="Selecione sua cidade">
                <option value="">Selecione uma cidade</option>
            </select>
            <p id="city-error" class="error-message"></p>
            <div class="modal-buttons">
                <button id="confirm-city-btn" onclick="confirmCity()" aria-label="Confirmar cidade">Confirmar</button>
                <button id="back-city-btn" class="secondary" onclick="window.parent.postMessage({ action: 'backToStateModal' }, '*')" aria-label="Voltar para seleção de estado">Voltar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Busca de Loja -->
    <div id="searching-modal" class="modal" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <h2>Buscando Loja...</h2>
            <p>Aguarde enquanto localizamos a loja mais próxima.</p>
        </div>
    </div>

    <!-- Modal de Loja Encontrada -->
    <div id="store-found-modal" class="modal" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="window.parent.postMessage({ action: 'hideModal', modalId: 'store-found-modal' }, '*')" aria-label="Fechar modal de loja encontrada">✖</button>
            <h2>Loja Encontrada!</h2>
            <p>Você está em <span id="store-location"></span>.</p>
            <button id="confirm-store-btn" onclick="confirmStore()" aria-label="Confirmar loja">Confirmar</button>
        </div>
    </div>

    <!-- Modal de Confirmação de Pedido -->
    <div id="confirmation-page" class="modal" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="window.parent.postMessage({ action: 'hideModal', modalId: 'confirmation-page' }, '*')" aria-label="Fechar modal de confirmação">✖</button>
            <h2>Pedido Confirmado!</h2>
            <p id="confirmation-details"></p>
            <button onclick="window.parent.postMessage({ action: 'backToMenu' }, '*')" aria-label="Voltar ao cardápio">Voltar ao Cardápio</button>
        </div>
    </div>

    <!-- Modal do Carrinho -->
    <div id="cart" aria-live="polite">
        <div id="cart-header">
            <h3>Carrinho <i class="fas fa-shopping-cart"></i></h3>
            <button onclick="window.parent.postMessage({ action: 'toggleCart' }, '*')" aria-label="Fechar carrinho">✖</button>
        </div>
        <div id="cart-items"></div>
        <div id="cart-total">Total: R$ 0,00</div>
        <div id="minimum-order-message">O pedido mínimo é R$ 10,00</div>
        <div id="cart-actions">
            <button id="clear-cart-btn" onclick="openConfirmClearModal()" aria-label="Limpar carrinho">Limpar</button>
            <button id="checkout-btn" onclick="openCheckoutModal()" aria-label="Finalizar pedido">Finalizar Pedido</button>
        </div>
    </div>

    <!-- Modal de Confirmação de Limpeza -->
    <div id="confirm-clear-modal" class="modal" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="window.parent.postMessage({ action: 'hideModal', modalId: 'confirm-clear-modal' }, '*')" aria-label="Fechar modal de confirmação de limpeza">✖</button>
            <h2><i class="fas fa-trash-alt"></i> Confirmar Limpeza</h2>
            <p>Tem certeza que deseja limpar o carrinho?</p>
            <div class="modal-buttons">
                <button id="confirm-clear-btn" onclick="confirmClearCart()" aria-label="Confirmar limpeza do carrinho">Confirmar</button>
                <button id="cancel-clear-btn" class="secondary" onclick="window.parent.postMessage({ action: 'hideModal', modalId: 'confirm-clear-modal' }, '*')" aria-label="Cancelar limpeza do carrinho">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Escolha de Sabores e Bordas -->
    <div id="flavor-modal" class="modal" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="window.parent.postMessage({ action: 'hideModal', modalId: 'flavor-modal' }, '*')" aria-label="Fechar modal de sabores">✖</button>
            <h2><i class="fas fa-pizza-slice"></i> Escolha os Sabores e Bordas</h2>
            <p id="flavor-progress">Selecione os sabores e bordas para o seu item</p>
            <div id="flavor-selections" class="flavor-selections"></div>
            <div class="modal-buttons">
                <button id="confirm-flavor-btn" onclick="confirmFlavors()" aria-label="Confirmar sabores e bordas">Confirmar</button>
                <button id="cancel-flavor-btn" class="secondary" onclick="window.parent.postMessage({ action: 'hideModal', modalId: 'flavor-modal' }, '*')" aria-label="Cancelar seleção de sabores e bordas">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Checkout -->
    <div id="checkout-modal" class="modal" aria-hidden="true" role="dialog">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="window.parent.postMessage({ action: 'hideModal', modalId: 'checkout-modal' }, '*')" aria-label="Fechar modal de checkout">✖</button>
            <h2><i class="fas fa-check-circle"></i> Finalizar Pedido</h2>
            <label for="name">Nome:</label>
            <input type="text" id="name" placeholder="Seu nome" required aria-label="Digite seu nome">
            <label for="address">Endereço:</label>
            <input type="text" id="address" placeholder="Seu endereço" required aria-label="Digite seu endereço">
            <label for="phone">Telefone:</label>
            <input type="tel" id="phone" placeholder="(XX) XXXXX-XXXX" required aria-label="Digite seu telefone">
            <p id="checkout-error" class="error-message"></p>
            <div class="modal-buttons">
                <button id="confirm-checkout-btn" onclick="confirmCheckout()" aria-label="Confirmar pedido">Confirmar</button>
                <button id="cancel-checkout-btn" class="secondary" onclick="window.parent.postMessage({ action: 'hideModal', modalId: 'checkout-modal' }, '*')" aria-label="Cancelar checkout">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Função para mostrar notificação (local ao modal)
        function showNotification(message, isError = false, autoHide = true) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 1rem;
                right: 1rem;
                background: ${isError ? 'linear-gradient(135deg, #dc2626, #b91c1c)' : 'linear-gradient(135deg, #16a34a, #15803d)'};
                color: white;
                padding: 0.75rem 1rem;
                border-radius: 0.5rem;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                z-index: 3000;
                opacity: 0;
                transform: translateY(-10px);
                transition: opacity 0.3s ease, transform 0.3s ease;
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('visible');
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 10);
            if (autoHide) {
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateY(-10px)';
                    setTimeout(() => document.body.removeChild(notification), 300);
                }, 3000);
            }
        }

        // Função para escapar HTML
        function escapeHTML(str) {
            return str.replace(/[&<>"'\/]/g, function (char) {
                return {
                    '&': '&',
                    '<': '<',
                    '>': '>',
                    '"': '"',
                    "'": ''',
                    '/': '/'
                }[char];
            });
        }

        // Variáveis globais
        let cartItems = [];
        let currentCombo = null;
        let currentItem = null;

        // Receber mensagens do index.html
        window.addEventListener('message', (event) => {
            if (event.data.action === 'showModal') {
                const modal = document.getElementById(event.data.modalId);
                if (modal) {
                    modal.classList.add('active');
                    modal.setAttribute('aria-hidden', 'false');
                    const focusable = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (focusable) focusable.focus();
                    trapFocus(event.data.modalId);
                }
            } else if (event.data.action === 'hideModal') {
                const modal = document.getElementById(event.data.modalId);
                if (modal) {
                    modal.classList.remove('active');
                    modal.setAttribute('aria-hidden', 'true');
                }
            } else if (event.data.action === 'toggleCart') {
                const cart = document.getElementById('cart');
                cart.classList.toggle('active');
                cart.setAttribute('aria-hidden', !cart.classList.contains('active'));
                if (cart.classList.contains('active')) {
                    const firstButton = cart.querySelector('.quantity-btn');
                    if (firstButton) firstButton.focus();
                }
            } else if (event.data.action === 'updateSelect') {
                const select = document.getElementById(event.data.selectId);
                if (select) select.innerHTML = '<option value="">Selecione o estado</option>' + event.data.options;
            } else if (event.data.action === 'showCityModal') {
                const stateSelect = document.getElementById('state-select');
                const state = stateSelect.value;
                if (!state) {
                    showNotification('Selecione um estado primeiro!', true);
                    return;
                }
                window.parent.postMessage({ action: 'hideModal', modalId: 'state-modal' }, '*');
                const cityModal = document.getElementById('city-modal');
                cityModal.classList.add('active');
                cityModal.setAttribute('aria-hidden', 'false');
                loadCities(state);
            } else if (event.data.action === 'backToStateModal') {
                window.parent.postMessage({ action: 'hideModal', modalId: 'city-modal' }, '*');
                const stateModal = document.getElementById('state-modal');
                stateModal.classList.add('active');
                stateModal.setAttribute('aria-hidden', 'false');
            } else if (event.data.action === 'updateFlavorModal') {
                currentCombo = event.data.combo;
                currentItem = event.data.item;
                const selections = document.getElementById('flavor-selections');
                const progress = document.getElementById('flavor-progress');
                selections.innerHTML = '';
                const traditionalFlavors = ['Calabresa', 'Margherita', 'Quatro Queijos', 'Frango com Catupiry', 'Portuguesa', 'Pepperoni'];
                const sweetFlavors = ['Chocolate', 'Brigadeiro', 'Banana com Canela', 'Morango com Chocolate'];
                const borderOptions = [
                    { name: 'Sem Borda', price: 0 },
                    { name: 'Catupiry', price: 5 },
                    { name: 'Cheddar', price: 5 },
                    { name: 'Chocolate', price: 6 }
                ];
                let totalFlavors = 0;
                if (currentCombo) {
                    totalFlavors = currentCombo.traditionalCount + currentCombo.sweetCount;
                    progress.textContent = `Selecione ${totalFlavors} sabor${totalFlavors > 1 ? 'es' : ''} e bordas para o seu combo`;
                    for (let i = 0; i < currentCombo.traditionalCount; i++) {
                        selections.innerHTML += `
                            <label>Pizza Tradicional ${i + 1}</label>
                            <select class="flavor-select" data-type="traditional" aria-label="Selecione o sabor tradicional ${i + 1}">
                                <option value="">Selecione o sabor tradicional</option>
                                ${traditionalFlavors.map(f => `<option value="${f}">${f}</option>`).join('')}
                            </select>
                            <label>Borda Tradicional ${i + 1}</label>
                            <select class="border-select" aria-label="Selecione a borda para a pizza tradicional ${i + 1}">
                                ${borderOptions.map(b => `<option value="${b.name}" data-price="${b.price}">${b.name} (R$ ${b.price.toFixed(2)})</option>`).join('')}
                            </select>
                        `;
                    }
                    for (let i = 0; i < currentCombo.sweetCount; i++) {
                        selections.innerHTML += `
                            <label>Pizza Doce ${i + 1}</label>
                            <select class="flavor-select" data-type="sweet" aria-label="Selecione o sabor doce ${i + 1}">
                                <option value="">Selecione o sabor doce</option>
                                ${sweetFlavors.map(f => `<option value="${f}">${f}</option>`).join('')}
                            </select>
                            <label>Borda Doce ${i + 1}</label>
                            <select class="border-select" aria-label="Selecione a borda para a pizza doce ${i + 1}">
                                ${borderOptions.map(b => `<option value="${b.name}" data-price="${b.price}">${b.name} (R$ ${b.price.toFixed(2)})</option>`).join('')}
                            </select>
                        `;
                    }
                } else if (currentItem) {
                    totalFlavors = 1;
                    progress.textContent = `Selecione a borda para a sua pizza`;
                    selections.innerHTML = `
                        <label>Borda para ${currentItem.name}</label>
                        <select class="border-select" aria-label="Selecione a borda para ${currentItem.name}">
                            ${borderOptions.map(b => `<option value="${b.name}" data-price="${b.price}">${b.name} (R$ ${b.price.toFixed(2)})</option>`).join('')}
                        </select>
                    `;
                }
            } else if (event.data.action === 'updateCart') {
                cartItems = event.data.items;
                const cartItemsDiv = document.getElementById('cart-items');
                const cartTotalDiv = document.getElementById('cart-total');
                const checkoutBtn = document.getElementById('checkout-btn');
                const minimumMessage = document.getElementById('minimum-order-message');
                cartItemsDiv.innerHTML = '';
                let total = 0;
                let itemCount = 0;
                cartItems.forEach(item => {
                    total += item.price * item.quantity;
                    itemCount += item.quantity;
                    cartItemsDiv.innerHTML += `
                        <div class="cart-item">
                            <div class="cart-item-details">
                                <span>${escapeHTML(item.name)}</span>
                                ${item.flavors.length > 1 ? `<span>Sabores: ${escapeHTML(item.flavors.join(', '))}</span>` : ''}
                                ${item.borders.length > 0 ? `<span>Bordas: ${escapeHTML(item.borders.map(b => b.name).join(', '))}</span>` : ''}
                                <span>R$ ${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="window.parent.postMessage({ action: 'updateQuantity', id: ${item.id}, change: -1 }, '*')" aria-label="Reduzir quantidade de ${item.name}">-</button>
                                <span>${item.quantity}</span>
                                <button class="quantity-btn" onclick="window.parent.postMessage({ action: 'updateQuantity', id: ${item.id}, change: 1 }, '*')" aria-label="Aumentar quantidade de ${item.name}">+</button>
                                <button class="remove-from-cart" onclick="window.parent.postMessage({ action: 'removeFromCart', id: ${item.id} }, '*')" aria-label="Remover ${item.name} do carrinho">Remover</button>
                            </div>
                        </div>
                    `;
                });
                cartTotalDiv.textContent = `Total: R$ ${total.toFixed(2)}`;
                minimumMessage.classList.toggle('visible', total < 10 && itemCount > 0);
                checkoutBtn.disabled = itemCount === 0 || total < 10;
            } else if (event.data.action === 'updateConfirmation') {
                document.getElementById('confirmation-details').textContent = event.data.details;
            }
        });

        // Funções internas dos modals
        function trapFocus(modalId) {
            const modal = document.getElementById(modalId);
            const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            modal.addEventListener('keydown', function (e) {
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                }
            });
        }

        async function loadCities(state) {
            try {
                const response = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${state}/municipios`);
                if (!response.ok) throw new Error('Erro ao carregar cidades');
                const cities = await response.json();
                document.getElementById('city-select').innerHTML = '<option value="">Selecione uma cidade</option>' +
                    cities.sort((a, b) => a.nome.localeCompare(b.nome)).map(c => `<option value="${c.nome}" data-id="${c.id}">${c.nome}</option>`).join('');
            } catch (error) {
                console.error('Erro ao carregar cidades:', error);
                document.getElementById('city-error').textContent = 'Erro ao carregar cidades. Tente novamente.';
                document.getElementById('city-error').classList.add('visible');
            }
        }

        function confirmCity() {
            const city = document.getElementById('city-select').value;
            if (!city) {
                document.getElementById('city-error').textContent = 'Selecione uma cidade primeiro!';
                document.getElementById('city-error').classList.add('visible');
                return;
            }
            document.getElementById('city-error').classList.remove('visible');
            window.parent.postMessage({ action: 'hideModal', modalId: 'city-modal' }, '*');
            const searchingModal = document.getElementById('searching-modal');
            searchingModal.classList.add('active');
            searchingModal.setAttribute('aria-hidden', 'false');
            setTimeout(() => {
                window.parent.postMessage({ action: 'hideModal', modalId: 'searching-modal' }, '*');
                const storeFoundModal = document.getElementById('store-found-modal');
                storeFoundModal.classList.add('active');
                storeFoundModal.setAttribute('aria-hidden', 'false');
                document.getElementById('store-location').textContent = `${city}, ${document.getElementById('state-select').value}`;
            }, 2000);
        }

        function confirmStore() {
            const city = document.getElementById('city-select').value;
            const state = document.getElementById('state-select').value;
            window.parent.postMessage({ action: 'confirmLocation', city, state }, '*');
            window.parent.postMessage({ action: 'hideModal', modalId: 'store-found-modal' }, '*');
        }

        function confirmFlavors() {
            const flavorSelects = document.querySelectorAll('.flavor-select');
            const borderSelects = document.querySelectorAll('.border-select');
            let flavors = [];
            let borders = [];
            let totalBorderPrice = 0;

            flavorSelects.forEach(select => {
                if (select.value) {
                    flavors.push(select.value);
                }
            });

            borderSelects.forEach(select => {
                const price = parseFloat(select.options[select.selectedIndex].dataset.price);
                borders.push({ name: select.value, price });
                totalBorderPrice += price;
            });

            if (currentCombo && flavors.length !== (currentCombo.traditionalCount + currentCombo.sweetCount)) {
                showNotification('Selecione todos os sabores necessários!', true);
                return;
            }

            window.parent.postMessage({
                action: 'confirmFlavors',
                flavors,
                borders,
                totalBorderPrice
            }, '*');
            window.parent.postMessage({ action: 'hideModal', modalId: 'flavor-modal' }, '*');
        }

        function openConfirmClearModal() {
            const confirmClearModal = document.getElementById('confirm-clear-modal');
            confirmClearModal.classList.add('active');
            confirmClearModal.setAttribute('aria-hidden', 'false');
            trapFocus('confirm-clear-modal');
        }

        function confirmClearCart() {
            window.parent.postMessage({ action: 'clearCart' }, '*');
            window.parent.postMessage({ action: 'hideModal', modalId: 'confirm-clear-modal' }, '*');
            window.parent.postMessage({ action: 'toggleCart' }, '*');
        }

        function openCheckoutModal() {
            const checkoutModal = document.getElementById('checkout-modal');
            checkoutModal.classList.add('active');
            checkoutModal.setAttribute('aria-hidden', 'false');
            document.getElementById('name').focus();
            trapFocus('checkout-modal');
        }

        function confirmCheckout() {
            const name = document.getElementById('name').value.trim();
            const address = document.getElementById('address').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const checkoutError = document.getElementById('checkout-error');

            if (!name || !address || !phone) {
                checkoutError.textContent = 'Preencha todos os campos!';
                checkoutError.classList.add('visible');
                return;
            }

            const phoneRegex = /^\(\d{2}\)\s\d{4,5}-\d{4}$/;
            if (!phoneRegex.test(phone)) {
                checkoutError.textContent = 'Telefone inválido! Use o formato (XX) XXXXX-XXXX';
                checkoutError.classList.add('visible');
                return;
            }

            checkoutError.classList.remove('visible');
            const total = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
            let orderDetails = `Novo Pedido\n\n`;
            orderDetails += `Cliente: ${escapeHTML(name)}\n`;
            orderDetails += `Endereço: ${escapeHTML(address)}\n`;
            orderDetails += `Telefone: ${escapeHTML(phone)}\n\n`;
            orderDetails += `Itens:\n`;
            cartItems.forEach(item => {
                orderDetails += `- ${item.quantity}x ${escapeHTML(item.name)} - R$ ${(item.price * item.quantity).toFixed(2)}\n`;
                if (item.flavors.length > 1) {
                    orderDetails += `  Sabores: ${escapeHTML(item.flavors.join(', '))}\n`;
                }
                if (item.borders.length > 0) {
                    orderDetails += `  Bordas: ${escapeHTML(item.borders.map(b => b.name).join(', '))}\n`;
                }
            });
            orderDetails += `\nTotal: R$ ${total.toFixed(2)}`;
            const whatsappUrl = `https://api.whatsapp.com/send?phone=+5562995771104&text=${encodeURIComponent(orderDetails)}`;
            window.open(whatsappUrl, '_blank');
            window.parent.postMessage({ action: 'confirmCheckout', name, address, phone }, '*');
            window.parent.postMessage({ action: 'hideModal', modalId: 'checkout-modal' }, '*');
        }
    </script>
</body>
</html>
