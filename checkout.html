<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">Checkout - La Casa de Pizzas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="config.js"></script>
  <style>
    body {
      background-color: var(--cor-fundo, #FFF8E7);
      color: var(--cor-texto, #2D2D2D);
      font-family: 'Poppins', sans-serif;
    }
    .custom-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 25px;
      transition: all 0.3s ease;
    }
    .custom-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .card {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--cor-primaria, #FF4500);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 15px;
      max-width: 600px;
      width: 90%;
    }
    .payment-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 15px;
      background-color: white;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .payment-btn:hover {
      border-color: var(--cor-primaria, #FF4500);
      background-color: #f5f5f5;
    }
    .payment-btn.selected {
      border-color: var(--cor-primaria, #FF4500);
      background-color: rgba(255, 69, 0, 0.05);
    }
    .payment-img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="bg-[var(--cor-primaria)] text-white p-4">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-4">
        <img id="logo" src="https://i.imgur.com/3wbh5W3.jpeg" alt="Logo" class="h-12">
        <h1 class="text-2xl font-bold" id="nome-pizzaria">La Casa de Pizzas</h1>
      </div>
      <div class="flex gap-4">
        <button onclick="window.location.href='index.html'" class="custom-btn bg-white text-[var(--cor-primaria)]" aria-label="Voltar ao cardápio">
          Voltar
        </button>
      </div>
    </div>
  </header>

  <section class="max-w-7xl mx-auto my-8 p-6">
    <h2 class="text-3xl font-bold mb-8 text-center">Finalizar Pedido</h2>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Itens do Carrinho -->
      <div class="card">
        <h3 class="text-2xl font-semibold mb-4">Seu Carrinho</h3>
        <div id="carrinho-lista" class="space-y-4"></div>
        <p class="text-lg font-bold mt-4">Total: R$ <span id="carrinho-total">0.00</span></p>
      </div>
      <!-- Formulário de Checkout -->
      <div class="card">
        <h3 class="text-2xl font-semibold mb-4">Informações de Entrega</h3>
        <div class="space-y-4">
          <input type="text" id="nome-cliente" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--cor-primaria)]" placeholder="Seu nome" aria-label="Nome do cliente">
          <input type="text" id="endereco" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--cor-primaria)]" placeholder="Endereço de entrega" aria-label="Endereço de entrega">
          <div class="mt-4">
            <p class="text-lg font-semibold mb-2">Método de Pagamento</p>
            <input type="hidden" id="metodo-pagamento" value="">
            <div class="flex gap-4">
              <button class="payment-btn" onclick="selecionarMetodoPagamento('pix')" data-metodo="pix" aria-label="Pagar com PIX">
                <img src="https://logospng.org/wp-content/uploads/pix.png" alt="PIX" class="payment-img">
                PIX
              </button>
              <button class="payment-btn" onclick="selecionarMetodoPagamento('cartao')" data-metodo="cartao" aria-label="Pagar com Cartão">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTyPBBZO_YQYBYPLcnwQHp7DcMOaOengxiPS7AhVCpA_maHQSg-QtdJF0k&s=10" alt="Cartão" class="payment-img">
                Cartão
              </button>
            </div>
          </div>
          <div id="info-pix" class="hidden p-4 bg-gray-100 rounded-lg">
            <p class="font-semibold">Chave PIX:</p>
            <p id="pix-chave"></p>
            <p class="mt-2">Após o pagamento, envie o comprovante para o WhatsApp.</p>
          </div>
          <div id="info-cartao" class="hidden p-4 bg-gray-100 rounded-lg">
            <p>Você será redirecionado para a página de pagamento com cartão.</p>
          </div>
          <button onclick="finalizarPedido()" class="w-full custom-btn bg-[var(--cor-primaria)] text-white font-semibold" aria-label="Finalizar pedido">
            Finalizar Pedido
          </button>
        </div>
      </div>
    </div>
  </section>

  <footer class="bg-[var(--cor-primaria)] text-white p-4 text-center">
    <p>© 2025 <span id="nome-pizzaria-footer">La Casa de Pizzas</span>. Todos os direitos reservados.</p>
    <div class="flex justify-center gap-4 mt-2">
      <a id="whatsapp-link" href="https://api.whatsapp.com/send?phone=5562995771104&text=Olá,%20gostaria%20de%20fazer%20um%20pedido!" target="_blank" class="text-white hover:underline" aria-label="Contato via WhatsApp">WhatsApp: <span id="whatsapp-numero">(62) 99577-1104</span></a>
      <a id="instagram-link" href="https://instagram.com/lacasadepizza2025" target="_blank" class="text-white hover:underline" aria-label="Instagram da pizzaria">Instagram: <span id="instagram-nome">@lacasadepizza2025</span></a>
    </div>
  </footer>

  <!-- Modal de Notificação -->
  <div id="modal-notificacao" class="modal hidden">
    <div class="modal-content">
      <h3 class="text-xl font-semibold mb-4" id="notificacao-titulo"></h3>
      <p id="notificacao-mensagem"></p>
      <button onclick="fecharNotificacao()" class="mt-4 custom-btn bg-[var(--cor-primaria)] text-white w-full" aria-label="Fechar notificação">Ok</button>
    </div>
  </div>

  <script>
    let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
    let totalCarrinho = 0;

    function aplicarConfiguracoes() {
      if (typeof config !== 'undefined') {
        document.documentElement.style.setProperty('--cor-primaria', config.corPrimaria);
        document.documentElement.style.setProperty('--cor-secundaria', config.corSecundaria);
        document.documentElement.style.setProperty('--cor-fundo', config.corFundo);
        document.documentElement.style.setProperty('--cor-texto', config.corTexto);
        document.getElementById('page-title').textContent = `Checkout - ${config.nomePizzaria}`;
        document.getElementById('logo').src = config.logoUrl;
        document.getElementById('nome-pizzaria').textContent = config.nomePizzaria;
        document.getElementById('nome-pizzaria-footer').textContent = config.nomePizzaria;
        document.getElementById('whatsapp-link').href = config.whatsappLink;
        document.getElementById('whatsapp-numero').textContent = config.whatsapp;
        document.getElementById('instagram-link').href = `https://instagram.com/${config.instagram.replace('@', '')}`;
        document.getElementById('instagram-nome').textContent = config.instagram;
        document.getElementById('pix-chave').textContent = config.pixChave;
      }
    }

    function initializeApp() {
      carregarCarrinho();
    }

    function checkConfigAndInitialize() {
      const maxAttempts = 10;
      let attempts = 0;

      const interval = setInterval(() => {
        if (typeof config !== 'undefined') {
          clearInterval(interval);
          aplicarConfiguracoes();
          initializeApp();
        } else if (attempts >= maxAttempts) {
          clearInterval(interval);
          console.error('Erro: Não foi possível carregar config.js após várias tentativas.');
          mostrarNotificacao('Erro', 'Não foi possível carregar as configurações. Verifique se o arquivo config.js está no mesmo diretório e se você está executando o projeto em um servidor local.');
        }
        attempts++;
      }, 500);
    }

    document.addEventListener('DOMContentLoaded', () => {
      checkConfigAndInitialize();
    });

    function carregarCarrinho() {
      const lista = document.getElementById('carrinho-lista');
      lista.innerHTML = '';
      if (!carrinho || carrinho.length === 0) {
        lista.innerHTML = '<p class="text-center text-gray-600">Seu carrinho está vazio.</p>';
        return;
      }
      totalCarrinho = 0;
      carrinho.forEach((item, index) => {
        const subtotal = item.preço * item.quantidade;
        totalCarrinho += subtotal;
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center border-b pb-2';
        div.innerHTML = `
          <div>
            <p class="font-semibold">${item.nome}</p>
            <p class="text-gray-600">Quantidade: ${item.quantidade}</p>
            <p>Subtotal: R$ ${subtotal.toFixed(2)}</p>
          </div>
          <div class="flex gap-2">
            <button onclick="alterarQuantidade(${index}, 1)" class="custom-btn bg-[var(--cor-primaria)] text-white" aria-label="Aumentar quantidade de ${item.nome}">+</button>
            <button onclick="alterarQuantidade(${index}, -1)" class="custom-btn bg-gray-500 text-white" aria-label="Diminuir quantidade de ${item.nome}">-</button>
            <button onclick="removerItem(${index})" class="custom-btn bg-red-500 text-white" aria-label="Remover ${item.nome} do carrinho">Remover</button>
          </div>
        `;
        lista.appendChild(div);
      });
      document.getElementById('carrinho-total').textContent = totalCarrinho.toFixed(2);
    }

    function alterarQuantidade(index, delta) {
      if (carrinho[index].quantidade + delta <= 0) {
        removerItem(index);
        return;
      }
      carrinho[index].quantidade += delta;
      localStorage.setItem('carrinho', JSON.stringify(carrinho));
      carregarCarrinho();
    }

    function removerItem(index) {
      carrinho.splice(index, 1);
      localStorage.setItem('carrinho', JSON.stringify(carrinho));
      carregarCarrinho();
    }

    window.selecionarMetodoPagamento = function(metodo) {
      document.getElementById('metodo-pagamento').value = metodo;
      document.querySelectorAll('.payment-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.querySelector(`.payment-btn[data-metodo="${metodo}"]`).classList.add('selected');
      document.getElementById('info-pix').classList.add('hidden');
      document.getElementById('info-cartao').classList.add('hidden');
      if (metodo === 'pix') {
        document.getElementById('info-pix').classList.remove('hidden');
      } else if (metodo === 'cartao') {
        document.getElementById('info-cartao').classList.remove('hidden');
      }
    };

    async function finalizarPedido() {
      const nomeCliente = document.getElementById('nome-cliente').value.trim();
      const endereco = document.getElementById('endereco').value.trim();
      const metodoPagamento = document.getElementById('metodo-pagamento').value;

      if (!nomeCliente || !endereco) {
        mostrarNotificacao('Erro', 'Por favor, preencha todos os campos.');
        return;
      }

      if (!metodoPagamento) {
        mostrarNotificacao('Erro', 'Por favor, selecione um método de pagamento.');
        return;
      }

      if (carrinho.length === 0) {
        mostrarNotificacao('Erro', 'Seu carrinho está vazio.');
        return;
      }

      const pedido = {
        id: Date.now().toString(),
        cliente: nomeCliente,
        endereco: endereco,
        metodoPagamento: metodoPagamento,
        itens: carrinho,
        total: totalCarrinho,
        data: new Date().toISOString()
      };

      try {
        let vendas = JSON.parse(localStorage.getItem('vendas')) || [];
        vendas.push(pedido);
        localStorage.setItem('vendas', JSON.stringify(vendas));

        if (metodoPagamento === 'cartao' && config.linkCartao) {
          window.location.href = config.linkCartao;
        } else {
          const mensagem = `Olá, gostaria de confirmar meu pedido!\n\nCliente: ${nomeCliente}\nEndereço: ${endereco}\nMétodo de Pagamento: ${metodoPagamento}\nItens:\n${carrinho.map(item => `- ${item.nome} (x${item.quantidade})`).join('\n')}\nTotal: R$ ${totalCarrinho.toFixed(2)}`;
          const whatsappUrl = `${config.whatsappLink}&text=${encodeURIComponent(mensagem)}`;
          window.open(whatsappUrl, '_blank');
        }

        carrinho = [];
        localStorage.setItem('carrinho', JSON.stringify(carrinho));
        mostrarNotificacao('Sucesso', 'Pedido finalizado com sucesso! Você será redirecionado ao cardápio.');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
      } catch (error) {
        console.error('Erro ao finalizar pedido:', error);
        mostrarNotificacao('Erro', 'Falha ao finalizar o pedido. Tente novamente.');
      }
    }

    function mostrarNotificacao(titulo, mensagem) {
      document.getElementById('notificacao-titulo').textContent = titulo;
      document.getElementById('notificacao-mensagem').textContent = mensagem;
      document.getElementById('modal-notificacao').classList.remove('hidden');
    }

    function fecharNotificacao() {
      document.getElementById('modal-notificacao').classList.add('hidden');
    }
  </script>
</body>
</html>
