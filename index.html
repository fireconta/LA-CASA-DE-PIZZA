<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title"></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="config.js" defer onload="onConfigLoaded()"></script>
  <style>
    body {
      background-color: var(--cor-fundo);
      color: var(--cor-texto);
      transition: all 0.3s ease;
    }
    .dark-mode {
      background-color: var(--cor-fundo-escuro);
      color: var(--cor-texto-escuro);
    }
    .pizza-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
    }
    .custom-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    .custom-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .card {
      background-color: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
      animation: fadeIn 0.5s ease-in;
    }
    .dark-mode .card {
      background-color: #374151;
    }
    .card:hover {
      transform: translateY(-3px);
    }
    input:focus, select:focus {
      outline: none;
      ring: 2px solid var(--cor-primaria);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--cor-primaria);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .back-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: none;
      padding: 10px;
      background-color: var(--cor-primaria);
      color: white;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .dark-mode .back-to-top {
      background-color: var(--cor-secundaria);
    }
    .stars {
      color: #FBBF24;
    }
  </style>
</head>
<body class="font-sans">
  <!-- Cabeçalho -->
  <header class="text-white text-center py-6" style="background-color: var(--cor-primaria);">
    <div class="flex justify-between items-center max-w-5xl mx-auto px-4">
      <img id="logo" src="" alt="Logo La Casa de Pizza's" class="h-24">
      <button id="toggle-dark-mode" class="custom-btn bg-gray-800 text-white" aria-label="Alternar modo escuro">
        <svg id="dark-mode-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
        </svg>
      </button>
    </div>
    <h1 class="text-4xl font-bold" id="nome-pizzaria"></h1>
    <p class="mt-2 text-lg">As melhores pizzas da cidade!</p>
  </header>

  <!-- Pizzas em Destaque -->
  <section id="promocoes" class="max-w-5xl mx-auto my-8 p-4">
    <h2 class="text-3xl font-semibold text-center mb-6">Pizzas em Promoção</h2>
    <div id="promocoes-lista" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <!-- Cardápio -->
  <section id="cardapio" class="max-w-5xl mx-auto my-8 p-4">
    <h2 class="text-3xl font-semibold text-center mb-6">Nosso Cardápio</h2>
    <div class="flex flex-wrap gap-4 mb-6 justify-center">
      <input type="text" id="pesquisa" class="p-3 border rounded-lg focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" placeholder="Pesquisar pizzas..." aria-label="Pesquisar pizzas">
      <select id="filtro-categoria" class="p-3 border rounded-lg focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" aria-label="Filtrar por categoria">
        <option value="">Todas as Categorias</option>
      </select>
    </div>
    <div id="cardapio-lista" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <div id="spinner-cardapio" class="spinner hidden"></div>
  </section>

  <!-- Seu Pedido -->
  <section id="pedido" class="max-w-5xl mx-auto my-8 p-6 bg-white rounded-lg shadow-lg dark-mode:bg-gray-700">
    <h2 class="text-3xl font-semibold text-center mb-6">Seu Pedido</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Formulário -->
      <div class="space-y-4">
        <div>
          <label class="block text-lg font-medium">Nome</label>
          <input type="text" id="nome" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" required aria-label="Seu nome">
        </div>
        <div>
          <label class="block text-lg font-medium">Endereço</label>
          <input type="text" id="endereco" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" required aria-label="Seu endereço">
        </div>
        <div>
          <label class="block text-lg font-medium">E-mail (para histórico e avaliações)</label>
          <input type="email" id="email" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" required aria-label="Seu e-mail">
        </div>
        <div>
          <label class="block text-lg font-medium">Cupom de Desconto</label>
          <input type="text" id="cupom" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" placeholder="Ex.: PROMO10" aria-label="Código de desconto">
          <button onclick="aplicarCupom()" class="mt-2 custom-btn text-white" style="background-color: var(--cor-primaria);" aria-label="Aplicar cupom">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM5 10a1 1 0 112 0 1 1 0 01-2 0zm8 0a1 1 0 112 0 1 1 0 01-2 0zm-3-3a1 1 0 112 0 1 1 0 01-2 0zm0 6a1 1 0 112 0 1 1 0 01-2 0z" clip-rule="evenodd" />
            </svg>
            Aplicar
          </button>
        </div>
        <div>
          <label class="block text-lg font-medium">Total</label>
          <input type="text" id="total" class="w-full p-3 border rounded-lg bg-gray-100 dark-mode:bg-gray-600" readonly value="R$ 0,00" aria-label="Total do pedido">
        </div>
        <button onclick="enviarPedido()" class="w-full custom-btn text-white font-semibold" style="background-color: var(--cor-primaria);" aria-label="Enviar pedido via WhatsApp">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
            <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
          </svg>
          Enviar Pedido
        </button>
      </div>
      <!-- Carrinho Visual -->
      <div>
        <h3 class="text-xl font-semibold mb-4">Itens Selecionados</h3>
        <div id="carrinho-lista" class="space-y-2"></div>
      </div>
    </div>
  </section>

  <!-- Histórico de Pedidos -->
  <section id="historico" class="max-w-5xl mx-auto my-8 p-6 bg-white rounded-lg shadow-lg dark-mode:bg-gray-700">
    <h2 class="text-3xl font-semibold text-center mb-6">Histórico de Pedidos</h2>
    <div class="space-y-4">
      <div>
        <label class="block text-lg font-medium">Digite seu e-mail para ver seus pedidos</label>
        <input type="email" id="email-historico" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" placeholder="seu-email@example.com" aria-label="E-mail para histórico">
        <button onclick="carregarHistorico()" class="mt-2 custom-btn text-white" style="background-color: var(--cor-primaria);" aria-label="Ver histórico de pedidos">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM5 10a1 1 0 112 0 1 1 0 01-2 0zm8 0a1 1 0 112 0 1 1 0 01-2 0zm-3-3a1 1 0 112 0 1 1 0 01-2 0zm0 6a1 1 0 112 0 1 1 0 01-2 0z" clip-rule="evenodd" />
          </svg>
          Ver Histórico
        </button>
      </div>
      <div id="historico-lista" class="space-y-4"></div>
      <div id="spinner-historico" class="spinner hidden"></div>
    </div>
  </section>

  <!-- Feedback -->
  <section id="feedback" class="max-w-5xl mx-auto my-8 p-6 bg-white rounded-lg shadow-lg dark-mode:bg-gray-700">
    <h2 class="text-3xl font-semibold text-center mb-6">Deixe seu Feedback</h2>
    <div class="space-y-4">
      <div>
        <label class="block text-lg font-medium">E-mail</label>
        <input type="email" id="feedback-email" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" required aria-label="Seu e-mail para feedback">
      </div>
      <div>
        <label class="block text-lg font-medium">Mensagem</label>
        <textarea id="feedback-mensagem" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" required aria-label="Sua mensagem de feedback"></textarea>
      </div>
      <button onclick="enviarFeedback()" class="w-full custom-btn text-white font-semibold" style="background-color: var(--cor-primaria);" aria-label="Enviar feedback">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
          <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
        </svg>
        Enviar Feedback
      </button>
    </div>
  </section>

  <!-- Rodapé -->
  <footer class="bg-gray-800 text-white text-center py-6 dark-mode:bg-gray-900">
    <div class="max-w-5xl mx-auto">
      <p>© 2025 <span id="nome-pizzaria-footer"></span>. Todos os direitos reservados.</p>
      <p>Contato: <span id="contato-footer"></span></p>
      <div class="flex justify-center gap-4 mt-4">
        <a href="#" id="instagram-link" target="_blank" class="text-white hover:text-gray-300" aria-label="Instagram">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.982-6.98.058-1.281.072-1.689.072-4.948 0-3.259-.014-3.667-.072-4.948-.196-4.354-2.617-6.78-6.981-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
          </svg>
        </a>
        <a href="#" id="facebook-link" target="_blank" class="text-white hover:text-gray-300" aria-label="Facebook">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"/>
          </svg>
        </a>
        <a href="#" id="whatsapp-link" target="_blank" class="text-white hover:text-gray-300" aria-label="WhatsApp">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.661-.941.916-.173.255-.347.339-.622.255-.273-.089-1.216-.252-2.364-.711-1.147-.459-1.944-.892-2.191-1.027-.247-.135-.486-.196-.727-.196-.241 0-.47.042-.669.119-.198.078-.669.427-.916.676-.247.248-.517.486-.689.689-.172.202-.297.406-.297.611 0 .194.074.403.198.566.125.163.349.529.646.676.297.149.625.193.889.193.263 0 .589-.05.813-.149 1.118-.498 1.922-1.638 2.086-1.891.165-.252.263-.404.263-.611 0-.208-.074-.403-.173-.566zm-6.073-5.619c-.248 0-.471.099-.669.297-.198.198-.346.446-.446.644-.099.198-.149.396-.149.594 0 .198.05.396.149.594.099.198.248.446.446.644.198.198.421.297.669.297.248 0 .471-.099.669-.297.198-.198.346-.446.446-.644.099-.198.149-.396.149-.594 0-.198-.05-.396-.149-.594-.099-.198-.248-.446-.446-.644-.198-.198-.421-.297-.669-.297zm5.838 0c-.248 0-.471.099-.669.297-.198.198-.346.446-.446.644-.099.198-.149.396-.149.594 0 .198.05.396.149.594.099.198.248.446.446.644.198.198.421.297.669.297.248 0 .471-.099.669-.297.198-.198.346-.446.446-.644.099-.198.149-.396.149-.594 0-.198-.05-.396-.149-.594-.099-.198-.248-.446-.446-.644-.198-.198-.421-.297-.669-.297z"/>
          </svg>
        </a>
      </div>
      <div class="mt-4">
        <h3 class="text-lg font-semibold">Assine nossa Newsletter</h3>
        <div class="flex justify-center gap-2 mt-2">
          <input type="email" id="newsletter-email" class="p-3 border rounded-lg focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" placeholder="Seu e-mail" aria-label="E-mail para newsletter">
          <button onclick="assinarNewsletter()" class="custom-btn bg-gray-600 text-white" aria-label="Assinar newsletter">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
              <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
            </svg>
            Assinar
          </button>
        </div>
      </div>
    </div>
  </footer>

  <!-- Botão Voltar ao Topo -->
  <button id="back-to-top" class="back-to-top" aria-label="Voltar ao topo">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
    </svg>
  </button>

  <!-- Modal de Confirmação -->
  <div id="modal-confirmacao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg dark-mode:bg-gray-700">
      <h3 class="text-xl font-semibold mb-4">Pedido Enviado!</h3>
      <p>Seu pedido foi enviado com sucesso. Você será redirecionado ao WhatsApp para confirmar.</p>
      <button onclick="fecharModal()" class="mt-4 custom-btn text-white" style="background-color: var(--cor-primaria);" aria-label="Fechar modal">
        Ok
      </button>
    </div>
  </div>

  <!-- Modal de Avaliação -->
  <div id="modal-avaliacao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg dark-mode:bg-gray-700">
      <h3 class="text-xl font-semibold mb-4">Avalie sua Experiência</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-lg font-medium">Nota (1 a 5)</label>
          <select id="avaliacao-nota" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" aria-label="Nota da avaliação">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div>
          <label class="block text-lg font-medium">Comentário</label>
          <textarea id="avaliacao-comentario" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" aria-label="Comentário da avaliação"></textarea>
        </div>
        <button onclick="enviarAvaliacao()" class="w-full custom-btn text-white font-semibold" style="background-color: var(--cor-primaria);" aria-label="Enviar avaliação">
          Enviar Avaliação
        </button>
      </div>
    </div>
  </div>

  <script>
    // Variáveis CSS
    function aplicarConfiguracoes() {
      document.documentElement.style.setProperty('--cor-primaria', config.corPrimaria);
      document.documentElement.style.setProperty('--cor-secundaria', config.corSecundaria);
      document.documentElement.style.setProperty('--cor-fundo', config.corFundo);
      document.documentElement.style.setProperty('--cor-texto', config.corTexto);
      document.documentElement.style.setProperty('--cor-fundo-escuro', config.corFundoEscuro);
      document.documentElement.style.setProperty('--cor-texto-escuro', config.corTextoEscuro);
      if (config.temaTemporada.ativado) {
        document.documentElement.style.setProperty('--cor-fundo', config.temaTemporada.corFundo);
        document.documentElement.style.setProperty('--cor-texto', config.temaTemporada.corTexto);
        document.body.style.backgroundImage = `url(${config.temaTemporada.imagemFundo})`;
        document.body.style.backgroundSize = 'cover';
      }
    }

    // Configurações dinâmicas
    let configLoaded = false;
    let pizzasCache = [];
    let personalizacoesCache = [];
    let cuponsCache = [];
    let descontoAplicado = 0;
    let pedidoAtual = null;

    function onConfigLoaded() {
      configLoaded = true;
      document.getElementById('page-title').textContent = config.nomePizzaria;
      document.getElementById('logo').src = config.logoUrl;
      document.getElementById('nome-pizzaria').textContent = config.nomePizzaria;
      document.getElementById('nome-pizzaria-footer').textContent = config.nomePizzaria;
      document.getElementById('contato-footer').textContent = config.contatoFooter;
      document.getElementById('instagram-link').href = config.redesSociais.instagram;
      document.getElementById('facebook-link').href = config.redesSociais.facebook;
      document.getElementById('whatsapp-link').href = config.redesSociais.whatsapp;
      aplicarConfiguracoes();
      initializeApp();
    }

    // Aguarda o DOM carregar
    document.addEventListener('DOMContentLoaded', () => {
      if (configLoaded) {
        initializeApp();
      } else {
        setTimeout(() => {
          if (typeof config === 'undefined') {
            console.error('Erro: config.js não foi carregado corretamente.');
            alert('Erro ao carregar configurações. Verifique o arquivo config.js.');
          } else {
            onConfigLoaded();
          }
        }, 1000);
      }

      // Modo escuro
      const darkMode = localStorage.getItem('darkMode') === 'true';
      if (darkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('dark-mode-icon').innerHTML = `
          <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/>
        `;
      }

      // Botão Voltar ao Topo
      window.addEventListener('scroll', () => {
        const btn = document.getElementById('back-to-top');
        btn.style.display = window.scrollY > 300 ? 'block' : 'none';
      });

      // Registrar acesso
      registrarAcesso('index.html');
    });

    // Função principal para inicializar o app
    async function initializeApp() {
      // Modo escuro
      document.getElementById('toggle-dark-mode').addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDark);
        document.getElementById('dark-mode-icon').innerHTML = isDark ? `
          <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/>
        ` : `
          <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
        `;
      });

      // Carregar categorias para filtro
      const filtroCategoria = document.getElementById('filtro-categoria');
      config.categoriasPizzas.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        filtroCategoria.appendChild(option);
      });

      // Carregar personalizações
      await carregarPersonalizacoes();

      // Carregar cupons
      await carregarCupons();

      // Carregar cardápio
      await carregarCardapio();
      await carregarPromocoes();

      // Filtro e pesquisa
      document.getElementById('pesquisa').addEventListener('input', filtrarCardapio);
      document.getElementById('filtro-categoria').addEventListener('change', filtrarCardapio);
    }

    // Carregar personalizações
    async function carregarPersonalizacoes() {
      try {
        const response = await fetch(`${config.googleSheetsApiUrl}?method=get&sheet=Personalizacoes`);
        personalizacoesCache = await response.json();
      } catch (error) {
        console.error('Erro ao carregar personalizações:', error);
      }
    }

    // Carregar cupons
    async function carregarCupons() {
      try {
        const response = await fetch(`${config.googleSheetsApiUrl}?method=get&sheet=Cupons`);
        cuponsCache = await response.json();
      } catch (error) {
        console.error('Erro ao carregar cupons:', error);
      }
    }

    // Carregar cardápio do Google Sheets
    async function carregarCardapio() {
      const cardapioLista = document.getElementById('cardapio-lista');
      const spinner = document.getElementById('spinner-cardapio');
      spinner.classList.remove('hidden');
      cardapioLista.innerHTML = '';

      try {
        const cachedData = localStorage.getItem('cardapioCache');
        const ultimaAtualizacaoCache = localStorage.getItem('ultimaAtualizacaoCache');
        if (cachedData && ultimaAtualizacaoCache === config.ultimaAtualizacao) {
          pizzasCache = JSON.parse(cachedData);
        } else {
          const response = await fetch(`${config.googleSheetsApiUrl}?method=get&sheet=Cardapio`);
          pizzasCache = await response.json();
          localStorage.setItem('cardapioCache', JSON.stringify(pizzasCache));
          localStorage.setItem('ultimaAtualizacaoCache', config.ultimaAtualizacao);
        }

        if (!pizzasCache || pizzasCache.length === 0) {
          cardapioLista.innerHTML = '<p class="text-center text-gray-600 col-span-full">Nenhuma pizza cadastrada.</p>';
          return;
        }

        pizzasCache.forEach(pizza => {
          const div = document.createElement('div');
          div.className = 'card';
          div.dataset.categoria = pizza.Categoria || 'Salgadas';
          const personalizacoesHtml = `
            <div class="mt-2">
              <label class="block text-sm font-medium">Borda:</label>
              <select class="borda-select w-full p-2 border rounded-lg" data-id="${pizza.ID}">
                <option value="">Sem borda</option>
                ${personalizacoesCache.filter(p => p.Tipo === 'Borda').map(p => `<option value="${p.ID}" data-preco="${p.Preco}">${p.Nome} (+R$ ${p.Preco.toFixed(2)})</option>`).join('')}
              </select>
            </div>
            <div class="mt-2">
              <label class="block text-sm font-medium">Extras:</label>
              <select class="extra-select w-full p-2 border rounded-lg" data-id="${pizza.ID}">
                <option value="">Sem extras</option>
                ${personalizacoesCache.filter(p => p.Tipo === 'Extra').map(p => `<option value="${p.ID}" data-preco="${p.Preco}">${p.Nome} (+R$ ${p.Preco.toFixed(2)})</option>`).join('')}
              </select>
            </div>
          `;
          const mediaNota = calcularMediaAvaliacao(pizza.ID);
          div.innerHTML = `
            <img src="${pizza.Imagem || config.imagemPadraoPizza}" alt="${pizza.Nome}" class="pizza-img mb-4" loading="lazy">
            <h3 class="text-xl font-bold">${pizza.Nome}</h3>
            <p class="text-gray-600 dark-mode:text-gray-300">${pizza.Descricao}</p>
            <p class="text-lg font-semibold mt-2">R$ ${parseFloat(pizza.Preco).toFixed(2)}</p>
            ${mediaNota ? `<p class="stars">Avaliação: ${'★'.repeat(Math.round(mediaNota))} (${mediaNota.toFixed(1)})</p>` : ''}
            ${personalizacoesHtml}
            <input type="number" min="0" value="0" class="quantidade w-16 p-2 border rounded-lg mt-2 focus:outline-none focus:ring-2" style="focus:ring-color: var(--cor-primaria);" data-id="${pizza.ID}" data-preco="${pizza.Preco}" aria-label="Quantidade de ${pizza.Nome}">
          `;
          cardapioLista.appendChild(div);
        });

        document.querySelectorAll('.quantidade, .borda-select, .extra-select').forEach(input => {
          input.addEventListener('change', atualizarCarrinho);
        });
      } catch (error) {
        console.error('Erro ao carregar cardápio:', error);
        cardapioLista.innerHTML = '<p class="text-center text-gray-600 col-span-full">Erro ao carregar o cardápio. Tente novamente mais tarde.</p>';
      } finally {
        spinner.classList.add('hidden');
      }
    }

    // Carregar pizzas em promoção
    async function carregarPromocoes() {
      const promocoesLista = document.getElementById('promocoes-lista');
      const promocoes = pizzasCache.filter(pizza => pizza.EmPromocao === true || pizza.EmPromocao === "true");
      if (!promocoes || promocoes.length === 0) {
        promocoesLista.innerHTML = '<p class="text-center text-gray-600 col-span-full">Nenhuma promoção disponível.</p>';
        return;
      }
      promocoes.forEach(pizza => {
        const div = document.createElement('div');
        div.className = 'card';
        const mediaNota = calcularMediaAvaliacao(pizza.ID);
        div.innerHTML = `
          <img src="${pizza.Imagem || config.imagemPadraoPizza}" alt="${pizza.Nome}" class="pizza-img mb-4" loading="lazy">
          <h3 class="text-xl font-bold">${pizza.Nome}</h3>
          <p class="text-gray-600 dark-mode:text-gray-300">${pizza.Descricao}</p>
          <p class="text-lg font-semibold mt-2">R$ ${parseFloat(pizza.Preco).toFixed(2)}</p>
          ${mediaNota ? `<p class="stars">Avaliação: ${'★'.repeat(Math.round(mediaNota))} (${mediaNota.toFixed(1)})</p>` : ''}
        `;
        promocoesLista.appendChild(div);
      });
    }

    // Filtrar cardápio
    function filtrarCardapio() {
      const pesquisa = document.getElementById('pesquisa').value.toLowerCase();
      const categoria = document.getElementById('filtro-categoria').value;
      const cards = document.querySelectorAll('#cardapio-lista .card');
      cards.forEach(card => {
        const nome = card.querySelector('h3').textContent.toLowerCase();
        const descricao = card.querySelector('p').textContent.toLowerCase();
        const cardCategoria = card.dataset.categoria;
        const matchesPesquisa = nome.includes(pesquisa) || descricao.includes(pesquisa);
        const matchesCategoria = !categoria || cardCategoria === categoria;
        card.style.display = matchesPesquisa && matchesCategoria ? 'block' : 'none';
      });
    }

    // Atualizar carrinho visual
    function atualizarCarrinho() {
      const carrinhoLista = document.getElementById('carrinho-lista');
      carrinhoLista.innerHTML = '';
      let total = 0;
      const itensSelecionados = [];

      document.querySelectorAll('.quantidade').forEach(input => {
        const quantidade = parseInt(input.value) || 0;
        if (quantidade > 0) {
          const pizzaId = input.dataset.id;
          const pizza = pizzasCache.find(p => p.ID === pizzaId);
          let precoPizza = parseFloat(pizza.Preco) * quantidade;

          // Personalizações
          const bordaSelect = document.querySelector(`.borda-select[data-id="${pizzaId}"]`);
          const extraSelect = document.querySelector(`.extra-select[data-id="${pizzaId}"]`);
          let bordaNome = '', extraNome = '', precoBorda = 0, precoExtra = 0;

          if (bordaSelect.value) {
            const borda = personalizacoesCache.find(p => p.ID === bordaSelect.value);
            bordaNome = borda.Nome;
            precoBorda = parseFloat(borda.Preco) * quantidade;
            precoPizza += precoBorda;
          }
          if (extraSelect.value) {
            const extra = personalizacoesCache.find(p => p.ID === extraSelect.value);
            extraNome = extra.Nome;
            precoExtra = parseFloat(extra.Preco) * quantidade;
            precoPizza += precoExtra;
          }

          total += precoPizza;
          itensSelecionados.push({
            id: pizzaId,
            nome: pizza.Nome,
            quantidade,
            precoBase: parseFloat(pizza.Preco),
            borda: bordaNome,
            extra: extraNome,
            precoBorda,
            precoExtra,
            precoTotal: precoPizza
          });

          const div = document.createElement('div');
          div.className = 'border-b pb-2';
          div.innerHTML = `
            <p><strong>${quantidade}x ${pizza.Nome}</strong> - R$ ${(parseFloat(pizza.Preco) * quantidade).toFixed(2)}</p>
            ${bordaNome ? `<p>Borda: ${bordaNome} (+R$ ${precoBorda.toFixed(2)})</p>` : ''}
            ${extraNome ? `<p>Extra: ${extraNome} (+R$ ${precoExtra.toFixed(2)})</p>` : ''}
            <p class="font-semibold">Subtotal: R$ ${precoPizza.toFixed(2)}</p>
          `;
          carrinhoLista.appendChild(div);
        }
      });

      // Aplicar desconto
      if (descontoAplicado > 0) {
        const descontoValor = total * (descontoAplicado / 100);
        total -= descontoValor;
        const div = document.createElement('div');
        div.className = 'border-t pt-2 text-green-600';
        div.innerHTML = `<p>Desconto (${descontoAplicado}%): -R$ ${descontoValor.toFixed(2)}</p>`;
        carrinhoLista.appendChild(div);
      }

      document.getElementById('total').value = `R$ ${total.toFixed(2)}`;
      return { total, itens: itensSelecionados };
    }

    // Aplicar cupom de desconto
    async function aplicarCupom() {
      const codigo = document.getElementById('cupom').value.trim().toUpperCase();
      if (!codigo) {
        alert('Digite um código de cupom.');
        return;
      }
      const cupom = cuponsCache.find(c => c.Codigo === codigo);
      if (!cupom) {
        alert('Cupom inválido.');
        return;
      }
      const validade = new Date(cupom.Validade);
      if (validade < new Date()) {
        alert('Cupom expirado.');
        return;
      }
      descontoAplicado = parseFloat(cupom.DescontoPercentual);
      atualizarCarrinho();
      alert(`Cupom ${codigo} aplicado! Desconto de ${descontoAplicado}% no total.`);
    }

    // Calcular média de avaliações
    let avaliacoesCache = [];
    async function carregarAvaliacoes() {
      try {
        const response = await fetch(`${config.googleSheetsApiUrl}?method=get&sheet=Avaliacoes`);
        avaliacoesCache = await response.json();
      } catch (error) {
        console.error('Erro ao carregar avaliações:', error);
      }
    }
    function calcularMediaAvaliacao(pizzaId) {
      const avaliacoesPizza = avaliacoesCache.filter(a => a.PizzaID === pizzaId);
      if (!avaliacoesPizza.length) return 0;
      const total = avaliacoesPizza.reduce((sum, a) => sum + parseInt(a.Nota), 0);
      return total / avaliacoesPizza.length;
    }

    // Enviar pedido
    window.enviarPedido = async function() {
      const nome = document.getElementById('nome').value.trim();
      const endereco = document.getElementById('endereco').value.trim();
      const email = document.getElementById('email').value.trim();
      const total = document.getElementById('total').value;

      if (!nome || !endereco || !email) {
        alert('Por favor, preencha nome, endereço e e-mail.');
        return;
      }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        alert('Por favor, insira um e-mail válido.');
        return;
      }

      const { total: totalNumerico, itens } = atualizarCarrinho();
      if (itens.length === 0) {
        alert('Selecione pelo menos uma pizza para fazer o pedido.');
        return;
      }

      let mensagem = `Novo Pedido - ${config.nomePizzaria}\nNome: ${nome}\nEndereço: ${endereco}\nE-mail: ${email}\nItens:\n`;
      itens.forEach(item => {
        mensagem += `${item.quantidade}x ${item.nome} - R$ ${(item.precoBase * item.quantidade).toFixed(2)}\n`;
        if (item.borda) mensagem += `  Borda: ${item.borda} (+R$ ${item.precoBorda.toFixed(2)})\n`;
        if (item.extra) mensagem += `  Extra: ${item.extra} (+R$ ${item.precoExtra.toFixed(2)})\n`;
      });
      if (descontoAplicado > 0) {
        const descontoValor = (totalNumerico / (1 - descontoAplicado / 100)) * (descontoAplicado / 100);
        mensagem += `Desconto (${descontoAplicado}%): -R$ ${descontoValor.toFixed(2)}\n`;
      }
      mensagem += `Total: ${total}`;

      try {
        const pedido = {
          ID: `pedido_${Date.now()}`,
          Nome: nome,
          Endereco: endereco,
          Email: email,
          Itens: JSON.stringify(itens),
          Total: totalNumerico,
          Data: new Date().toISOString()
        };
        await fetch(`${config.googleSheetsApiUrl}?method=add&sheet=Pedidos`, {
          method: 'POST',
          body: JSON.stringify(pedido),
          headers: { 'Content-Type': 'application/json' }
        });
        pedidoAtual = pedido;
        document.getElementById('modal-confirmacao').classList.remove('hidden');
      } catch (error) {
        console.error('Erro ao enviar pedido:', error);
        alert('Erro ao enviar o pedido. Verifique a conexão com o Google Sheets.');
      }
    };

    // Fechar modal e abrir WhatsApp
    window.fecharModal = function() {
      document.getElementById('modal-confirmacao').classList.add('hidden');
      const nome = document.getElementById('nome').value.trim();
      const endereco = document.getElementById('endereco').value.trim();
      const total = document.getElementById('total').value;
      const { itens } = atualizarCarrinho();
      let mensagem = `Novo Pedido - ${config.nomePizzaria}\nNome: ${nome}\nEndereço: ${endereco}\nItens:\n`;
      itens.forEach(item => {
        mensagem += `${item.quantidade}x ${item.nome} - R$ ${(item.precoBase * item.quantidade).toFixed(2)}\n`;
        if (item.borda) mensagem += `  Borda: ${item.borda} (+R$ ${item.precoBorda.toFixed(2)})\n`;
        if (item.extra) mensagem += `  Extra: ${item.extra} (+R$ ${item.precoExtra.toFixed(2)})\n`;
      });
      if (descontoAplicado > 0) {
        const descontoValor = (parseFloat(total.replace('R$ ', '')) / (1 - descontoAplicado / 100)) * (descontoAplicado / 100);
        mensagem += `Desconto (${descontoAplicado}%): -R$ ${descontoValor.toFixed(2)}\n`;
      }
      mensagem += `Total: ${total}`;
      const url = `https://wa.me/${config.numeroWhatsApp}?text=${encodeURIComponent(mens