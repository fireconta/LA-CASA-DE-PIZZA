<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - La Casa de Pizzas</title>
  <script src="[invalid url, do not cite]
  <style>
    :root {
      --primary-color: #FF4500;
      --secondary-color: #FFD700;
      --background-color: #FFF8E7;
      --text-color: #2D2D2D;
    }

    .dark-mode {
      --background-color: #1F2937;
      --text-color: #F3F4F6;
      --bg-white: #374151;
    }

    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 5px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    .image-preview {
      display: none;
      max-width: 150px;
      max-height: 150px;
      object-fit: cover;
      margin-top: 10px;
      border-radius: 5px;
    }

    .loading {
      display: none;
      margin-top: 10px;
      font-size: 14px;
      color: var(--text-color);
    }
  </style>
</head>
<body class="bg-[var(--background-color)] text-[var(--text-color)] font-sans">
  <header class="bg-[var(--primary-color)] text-white p-4 flex justify-between items-center shadow-md">
    <div class="flex items-center gap-4">
      <img id="logo" src="[invalid url, do not cite] alt="Logo da La Casa de Pizzas" class="h-16 rounded-lg">
      <h1 class="text-2xl font-bold">Dashboard - La Casa de Pizzas</h1>
    </div>
    <div class="flex gap-2">
      <button onclick="toggleDarkMode()" class="bg-[var(--secondary-color)] text-[var(--text-color)] px-4 py-2 rounded hover:bg-white transition"><i class="fas fa-moon mr-2"></i>Modo Escuro</button>
      <button onclick="logout()" class="bg-[var(--secondary-color)] text-[var(--text-color)] px-4 py-2 rounded hover:bg-white transition"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
    </div>
  </header>

  <div class="container mx-auto p-4 max-w-7xl">
    <div class="tabs flex flex-wrap gap-2 justify-center mb-4">
      <button class="tab-btn px-4 py-2 rounded-t-lg bg-gray-200 text-gray-800 hover:bg-gray-300 active:bg-[var(--primary-color)] active:text-white transition font-semibold" onclick="openTab('info-tab')" aria-selected="true"><i class="fas fa-info-circle mr-2"></i>Informações</button>
      <button class="tab-btn px-4 py-2 rounded-t-lg bg-gray-200 text-gray-800 hover:bg-gray-300 active:bg-[var(--primary-color)] active:text-white transition font-semibold" onclick="openTab('stats-tab')" aria-selected="false"><i class="fas fa-chart-pie mr-2"></i>Estatísticas</button>
      <button class="tab-btn px-4 py-2 rounded-t-lg bg-gray-200 text-gray-800 hover:bg-gray-300 active:bg-[var(--primary-color)] active:text-white transition font-semibold" onclick="openTab('add-item-tab')" aria-selected="false"><i class="fas fa-plus-circle mr-2"></i>Adicionar Item</button>
      <button class="tab-btn px-4 py-2 rounded-t-lg bg-gray-200 text-gray-800 hover:bg-gray-300 active:bg-[var(--primary-color)] active:text-white transition font-semibold" onclick="openTab('menu-tab')" aria-selected="false"><i class="fas fa-pizza-slice mr-2"></i>Gerenciar Cardápio</button>
    </div>

    <div id="info-tab" class="tab-content bg-white p-6 rounded-b-lg shadow-md">
      <div class="info-section">
        <h2 class="text-2xl font-bold text-[var(--primary-color)] mb-4">Informações da Pizzaria</h2>
        <p class="mb-2"><strong>Nome:</strong> <span id="pizzaria-name">La Casa de Pizzas</span></p>
        <p class="mb-2">
          <strong>WhatsApp:</strong>
          <a id="whatsapp-link" href="[invalid url, do not cite] target="_blank" class="text-[var(--primary-color)] hover:underline">(11) 91234-5678</a>
        </p>
        <p>
          <strong>Instagram:</strong>
          <a id="instagram-link" href="[invalid url, do not cite] target="_blank" class="text-[var(--primary-color)] hover:underline">@lacasadepizzas</a>
        </p>
      </div>
    </div>

    <div id="stats-tab" class="tab-content hidden bg-white p-6 rounded-b-lg shadow-md">
      <div class="stats-section">
        <h2 class="text-2xl font-bold text-[var(--primary-color)] mb-4">Estatísticas</h2>
        <p class="mb-2"><strong>Total de Itens:</strong> <span id="total-items">0</span></p>
        <p class="mb-2"><strong>Categoria Mais Popular:</strong> <span id="popular-category">N/A</span></p>
        <p class="mb-2"><strong>Item Mais Bem Avaliado:</strong> <span id="top-rated-item">N/A</span></p>
        <p class="mb-2"><strong>Item Mais Caro:</strong> <span id="most-expensive-item">N/A</span></p>
        <p class="mb-2"><strong>Média de Avaliações:</strong> <span id="average-rating">0.0</span></p>
        <canvas id="category-chart" class="mt-4"></canvas>
      </div>
    </div>

    <div id="add-item-tab" class="tab-content hidden bg-white p-6 rounded-b-lg shadow-md">
      <div class="add-item-section">
        <h2 class="text-2xl font-bold text-[var(--primary-color)] mb-4">Adicionar Novo Item</h2>
        <form id="add-item-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="tooltip">
            <label for="item-name" class="block font-medium mb-1">Nome:</label>
            <input type="text" id="item-name" placeholder="Nome do item" required class="w-full p-2 border rounded" aria-label="Nome do item">
            <span class="tooltip-text">Digite o nome do item (ex.: Pizza Margherita).</span>
          </div>
          <div class="tooltip">
            <label for="item-category" class="block font-medium mb-1">Categoria:</label>
            <select id="item-category" required class="w-full p-2 border rounded" aria-label="Categoria do item">
              <option value="" disabled selected>Selecione a categoria</option>
              <option value="Salgadas">Salgadas</option>
              <option value="Doces">Doces</option>
              <option value="Vegetarianas">Vegetarianas</option>
              <option value="Bebidas">Bebidas</option>
              <option value="Combos">Combos</option>
            </select>
            <span class="tooltip-text">Escolha a categoria do item.</span>
          </div>
          <div class="tooltip">
            <label for="item-price" class="block font-medium mb-1">Preço (R$):</label>
            <input type="number" id="item-price" placeholder="Preço (R$)" step="0.01" min="0" required class="w-full p-2 border rounded" aria-label="Preço do item">
            <span class="tooltip-text">Insira o preço base do item (ex.: 29.90).</span>
          </div>
          <div class="tooltip">
            <label for="item-image" class="block font-medium mb-1">URL da Imagem:</label>
            <input type="url" id="item-image" placeholder="URL da imagem" required class="w-full p-2 border rounded" aria-label="URL da imagem">
            <img id="image-preview" class="image-preview" alt="Pré-visualização da imagem">
            <div id="image-loading" class="loading">Carregando...</div>
            <span class="tooltip-text">Insira uma URL de imagem válida (ex.: .jpg, .png).</span>
          </div>
          <div class="col-span-2 tooltip">
            <label for="item-description" class="block font-medium mb-1">Descrição:</label>
            <textarea id="item-description" placeholder="Descrição do item" required class="w-full p-2 border rounded" aria-label="Descrição do item"></textarea>
            <span class="tooltip-text">Descreva o item para os clientes.</span>
          </div>
          <div class="col-span-2 tooltip">
            <label for="item-ingredients" class="block font-medium mb-1">Ingredientes (separados por vírgula):</label>
            <input type="text" id="item-ingredients" placeholder="Ingredientes (separados por vírgula)" class="w-full p-2 border rounded" aria-label="Ingredientes do item">
            <span class="tooltip-text">Liste os ingredientes (ex.: tomate, muçarela, manjericão).</span>
          </div>
          <div class="col-span-2">
            <label class="block font-medium mb-1">Tamanhos:</label>
            <div id="sizes-container" class="space-y-2"></div>
            <button type="button" onclick="addSizeField()" class="mt-2 bg-[var(--primary-color)] text-white px-4 py-2 rounded hover:bg-[var(--secondary-color)] transition" aria-label="Adicionar tamanho"><i class="fas fa-plus mr-2"></i>Adicionar Tamanho</button>
          </div>
          <div class="col-span-2">
            <label class="block font-medium mb-1">Extras Disponíveis:</label>
            <div id="extras-container" class="space-y-2"></div>
            <button type="button" onclick="addExtraField()" class="mt-2 bg-[var(--primary-color)] text-white px-4 py-2 rounded hover:bg-[var(--secondary-color)] transition" aria-label="Adicionar extra"><i class="fas fa-plus mr-2"></i>Adicionar Extra</button>
          </div>
          <div class="col-span-2 flex gap-4">
            <button type="submit" class="bg-[var(--primary-color)] text-white px-4 py-2 rounded hover:bg-[var(--secondary-color)] transition" aria-label="Adicionar item"><i class="fas fa-save mr-2"></i>Adicionar</button>
            <button type="button" onclick="addAndContinue()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-[var(--secondary-color)] transition" aria-label="Adicionar e continuar"><i class="fas fa-plus-circle mr-2"></i>Adicionar e Continuar</button>
          </div>
        </form>
      </div>
    </div>

    <div id="menu-tab" class="tab-content hidden bg-white p-6 rounded-b-lg shadow-md">
      <div class="menu-section">
        <h2 class="text-2xl font-bold text-[var(--primary-color)] mb-4">Gerenciamento do Cardápio</h2>
        <div class="filter-section flex flex-wrap gap-4 mb-4">
          <input type="text" id="search-input" placeholder="Pesquisar por nome..." class="p-2 border rounded flex-1 min-w-[200px]" aria-label="Pesquisar por nome">
          <select id="category-filter" class="p-2 border rounded" aria-label="Filtrar por categoria">
            <option value="">Todas as Categorias</option>
            <option value="Salgadas">Salgadas</option>
            <option value="Doces">Doces</option>
            <option value="Vegetarianas">Vegetarianas</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Combos">Combos</option>
          </select>
          <button onclick="exportCardapio('json')" class="bg-[var(--primary-color)] text-white px-4 py-2 rounded hover:bg-[var(--secondary-color)] transition" aria-label="Exportar cardápio como JSON"><i class="fas fa-file-export mr-2"></i>Exportar JSON</button>
          <button onclick="exportCardapio('csv')" class="bg-[var(--primary-color)] text-white px-4 py-2 rounded hover:bg-[var(--secondary-color)] transition" aria-label="Exportar cardápio como CSV"><i class="fas fa-file-csv mr-2"></i>Exportar CSV</button>
        </div>
        <table id="menu-table" class="w-full table-auto">
          <thead>
            <tr>
              <th class="p-2 bg-[var(--primary-color)] text-white cursor-pointer hover:bg-[var(--secondary-color)]" onclick="sortMenuItems('nome')">Nome</th>
              <th class="p-2 bg-[var(--primary-color)] text-white cursor-pointer hover:bg-[var(--secondary-color)]" onclick="sortMenuItems('categoria')">Categoria</th>
              <th class="p-2 bg-[var(--primary-color)] text-white cursor-pointer hover:bg-[var(--secondary-color)]" onclick="sortMenuItems('preço')">Preço</th>
              <th class="p-2 bg-[var(--primary-color)] text-white cursor-pointer hover:bg-[var(--secondary-color)]" onclick="sortMenuItems('avaliacao')">Avaliação</th>
              <th class="p-2 bg-[var(--primary-color)] text-white">Ações</th>
            </tr>
          </thead>
          <tbody id="menu-items"></tbody>
        </table>
        <div class="pagination mt-4 flex justify-center gap-2">
          <button onclick="changePage(-1)" class="bg-[var(--primary-color)] text-white px-4 py-2 rounded hover:bg-[var(--secondary-color)] disabled:bg-gray-400 disabled:cursor-not-allowed" id="prev-page" disabled><i class="fas fa-chevron-left mr-2"></i>Anterior</button>
          <span id="page-info" class="self-center">Página 1</span>
          <button onclick="changePage(1)" class="bg-[var(--primary-color)] text-white px-4 py-2 rounded hover:bg-[var(--secondary-color)] disabled:bg-gray-400 disabled:cursor-not-allowed" id="next-page"><i class="fas fa-chevron-right mr-2"></i>Próxima</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para edição de itens -->
  <div id="edit-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="modal-content bg-[var(--bg-white, white)] p-6 rounded-lg w-11/12 max-w-2xl">
      <button class="close-btn absolute top-2 right-2 bg-gray-300 text-gray-800 p-2 rounded-full hover:bg-gray-400" onclick="closeModal()" aria-label="Fechar modal"><i class="fas fa-times"></i></button>
      <h2 class="text-2xl font-bold text-[var(--primary-color)] mb-4">Editar Item</h2>
      <form id="edit-item-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="edit-item-id">
        <div class="tooltip">
          <label for="edit-item-name" class="block font-medium mb-1">Nome:</label>
          <input type="text" id="edit-item-name" placeholder="Nome do item" required class="w-full p-2 border rounded" aria-label="Nome do item">
          <span class="tooltip-text">Digite o nome do item (ex.: Pizza Margherita).</span>
        </div>
        <div class="tooltip">
          <label for="edit-item-category" class="block font-medium mb-1">Categoria:</label>
          <select id="edit-item-category" required class="w-full p-2 border rounded" aria-label="Categoria do item">
            <option value="Salgadas">Salgadas</option>
            <option value="Doces">Doces</option>
            <option value="Vegetarianas">Vegetarianas</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Combos">Combos</option>
          </select>
          <span class="tooltip-text">Escolha a categoria do item.</span>
        </div>
        <div class="tooltip">
          <label for="edit-item-price" class="block font-medium mb-1">Preço (R$):</label>
          <input type="number" id="edit-item-price" placeholder="Preço (R$)" step="0.01" min="0" required class="w-full p-2 border rounded" aria-label="Preço do item">
          <span class="tooltip-text">Insira o preço base do item (ex.: 29.90).</span>
        </div>
        <div class="tooltip">
          <label for="edit-item-image" class="block font-medium mb-1">URL da Imagem:</label>
          <input type="url" id="edit-item-image" placeholder="URL da imagem" required class="w-full p-2 border rounded" aria-label="URL da imagem">
          <img id="edit-image-preview" class="image-preview" alt="Pré-visualização da imagem">
          <div id="edit-image-loading" class="loading">Carregando...</div>
          <span class="tooltip-text">Insira uma URL de imagem válida (ex.: .jpg, .png).</span>
        </div>
        <div class="col-span-2 tooltip">
          <label for="edit-item-description" class="block font-medium mb-1">Descrição:</label>
          <textarea id="edit-item-description" placeholder="Descrição do item" required class="w-full p-2 border rounded" aria-label="Descrição do item"></textarea>
          <span class="tooltip-text">Descreva o item para os clientes.</span>
        </div>
        <div class="col-span-2 tooltip">
          <label for="edit-item-ingredients" class="block font-medium mb-1">Ingredientes (separados por vírgula):</label>
          <input type="text" id="edit-item-ingredients" placeholder="Ingredientes (separados por vírgula)" class="w-full p-2 border rounded" aria-label="Ingredientes do item">
          <span class="tooltip-text">Liste os ingredientes (ex.: tomate, muçarela, manjericão).</span>
        </div>
        <div class="col-span-2">
          <label class="block font-medium mb-1">Tamanhos:</label>
          <div id="edit-sizes-container" class="space-y-2"></div>
          <button type="button" onclick="addEditSizeField()" class="mt-2 bg-[var(--primary-color)] text-white px-4 py-2 rounded hover:bg-[var(--secondary-color)] transition" aria-label="Adicionar tamanho"><i class="fas fa-plus mr-2"></i>Adicionar Tamanho</button>
        </div>
        <div class="col-span-2">
          <label class="block font-medium mb-1">Extras Disponíveis:</label>
          <div id="edit-extras-container" class="space-y-2"></div>
          <button type="button" onclick="addEditExtraField()" class="mt-2 bg-[var(--primary-color)] text-white px-4 py-2 rounded hover:bg-[var(--secondary-color)] transition" aria-label="Adicionar extra"><i class="fas fa-plus mr-2"></i>Adicionar Extra</button>
        </div>
        <div class="col-span-2">
          <button type="submit" class="bg-[var(--primary-color)] text-white px-4 py-2 rounded hover:bg-[var(--secondary-color)] transition" aria-label="Salvar alterações"><i class="fas fa-save mr-2"></i>Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para confirmação de exclusão -->
  <div id="delete-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="modal-content bg-[var(--bg-white, white)] p-6 rounded-lg w-11/12 max-w-md">
      <h2 class="text-xl font-bold text-[var(--primary-color)] mb-4">Confirmar Exclusão</h2>
      <p class="mb-4">Tem certeza de que deseja excluir o item "<span id="delete-item-name"></span>"? Esta ação não pode ser desfeita.</p>
      <div class="flex justify-end gap-4">
        <button onclick="closeDeleteModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" aria-label="Cancelar exclusão"><i class="fas fa-times mr-2"></i>Cancelar</button>
        <button onclick="confirmDelete()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" aria-label="Confirmar exclusão"><i class="fas fa-trash mr-2"></i>Excluir</button>
      </div>
    </div>
  </div>

  <script src="config.js" id="config-script"></script>
  <script src="cardapio.js" id="cardapio-script"></script>
  <script src="[invalid url, do not cite]
  <script>
    let cardapioData = [];
    let categoryChart;
    let currentPage = 1;
    const itemsPerPage = 10;
    let filteredItems = [];
    let sortField = 'nome';
    let sortDirection = 1;
    let itemToDelete = null;

    // Verifica autenticação
    if (!localStorage.getItem("adminToken")) {
      window.location.href = "admin.html";
    }

    // Carrega os dados do cardápio do localStorage ou usa o padrão
    function loadCardapioData() {
      const storedData = localStorage.getItem("cardapioData");
      if (storedData) {
        try {
          cardapioData = JSON.parse(storedData);
        } catch (err) {
          console.error("Erro ao carregar dados do localStorage:", err);
          cardapioData = [...window.cardapio];
          saveCardapioData();
        }
      } else {
        cardapioData = [...window.cardapio];
        saveCardapioData();
      }
      filteredItems = [...cardapioData];
    }

    // Salva os dados do cardápio no localStorage
    function saveCardapioData() {
      localStorage.setItem("cardapioData", JSON.stringify(cardapioData));
    }

    // Função para inicializar o dashboard
    function initializeDashboard() {
      if (!window.config) {
        console.error("Erro: Config não foi carregado corretamente.");
        alert("Erro: Configuração não carregada. Verifique o arquivo config.js.");
        return;
      }

      if (!window.cardapio) {
        console.error("Erro: Cardápio não foi carregado corretamente.");
        alert("Erro: Cardápio não carregado. Verifique o arquivo cardapio.js.");
        return;
      }

      loadCardapioData();

      document.documentElement.style.setProperty('--primary-color', window.config.primaryColor);
      document.documentElement.style.setProperty('--secondary-color', window.config.secondaryColor);
      document.documentElement.style.setProperty('--background-color', window.config.backgroundColor);
      document.documentElement.style.setProperty('--text-color', window.config.textColor);

      document.getElementById("logo").src = window.config.logoUrl;
      document.getElementById("pizzaria-name").textContent = window.config.pizzariaName;
      document.getElementById("whatsapp-link").href = window.config.whatsappLink;
      document.getElementById("whatsapp-link").textContent = window.config.whatsappNumber;
      document.getElementById("instagram-link").href = window.config.instagramUrl;
      document.getElementById("instagram-link").textContent = window.config.instagramHandle;

      updateStatistics();
      renderMenuItems();

      let debounceTimeout;
      document.getElementById("search-input").addEventListener("input", function() {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(filterMenuItems, 300);
      });
      document.getElementById("category-filter").addEventListener("change", filterMenuItems);

      document.getElementById("item-image").addEventListener("input", function() {
        const url = this.value;
        const preview = document.getElementById("image-preview");
        const loading = document.getElementById("image-loading");

        if (url) {
          if (!isValidImageUrl(url)) {
            alert("Por favor, insira uma URL de imagem válida (ex.: .jpg, .png, .gif).");
            this.value = "";
            preview.style.display = "none";
            loading.style.display = "none";
            return;
          }

          loading.style.display = "block";
          preview.style.display = "none";
          preview.src = url;
          preview.onload = function() {
            loading.style.display = "none";
            preview.style.display = "block";
          };
          preview.onerror = function() {
            loading.style.display = "none";
            preview.style.display = "none";
            alert("URL da imagem inválida ou não foi possível carregar. Verifique e tente novamente.");
            this.value = "";
          };
        } else {
          loading.style.display = "none";
          preview.style.display = "none";
        }
      });

      document.getElementById("edit-item-image").addEventListener("input", function() {
        const url = this.value;
        const preview = document.getElementById("edit-image-preview");
        const loading = document.getElementById("edit-image-loading");

        if (url) {
          if (!isValidImageUrl(url)) {
            alert("Por favor, insira uma URL de imagem válida (ex.: .jpg, .png, .gif).");
            this.value = "";
            preview.style.display = "none";
            loading.style.display = "none";
            return;
          }

          loading.style.display = "block";
          preview.style.display = "none";
          preview.src = url;
          preview.onload = function() {
            loading.style.display = "none";
            preview.style.display = "block";
          };
          preview.onerror = function() {
            loading.style.display = "none";
            preview.style.display = "none";
            alert("URL da imagem inválida ou não foi possível carregar. Verifique e tente novamente.");
            this.value = "";
          };
        } else {
          loading.style.display = "none";
          preview.style.display = "none";
        }
      });
    }

    function isValidImageUrl(url) {
      const regex = /\.(jpeg|jpg|gif|png)$/i;
      return regex.test(url);
    }

    function updateStatistics() {
      const totalItems = cardapioData.length;
      document.getElementById("total-items").textContent = totalItems;

      const categoryCount = {};
      cardapioData.forEach(item => {
        categoryCount[item.categoria] = (categoryCount[item.categoria] || 0) + 1;
      });
      const popularCategory = Object.keys(categoryCount).reduce((a, b) =>
        categoryCount[a] > categoryCount[b] ? a : b, "N/A");
      document.getElementById("popular-category").textContent = popularCategory;

      const topRatedItem = cardapioData.reduce((top, item) => {
        if (!item.avaliacao) return top;
        return !top || item.avaliacao > top.avaliacao ? item : top;
      }, null);
      document.getElementById("top-rated-item").textContent = topRatedItem ? topRatedItem.nome : "N/A";

      const mostExpensiveItem = cardapioData.reduce((top, item) => {
        return !top || item.preço > top.preço ? item : top;
      }, null);
      document.getElementById("most-expensive-item").textContent = mostExpensiveItem ? mostExpensiveItem.nome : "N/A";

      const averageRating = cardapioData.reduce((sum, item) => sum + (item.avaliacao || 0), 0) / cardapioData.length;
      document.getElementById("average-rating").textContent = averageRating.toFixed(1);

      const ctx = document.getElementById("category-chart").getContext("2d");
      if (categoryChart) categoryChart.destroy();
      categoryChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: Object.keys(categoryCount),
          datasets: [{
            label: "Itens por Categoria",
            data: Object.values(categoryCount),
            backgroundColor: [
              "#FF4500",
              "#FFD700",
              "#36A2EB",
              "#FF6384",
              "#4BC0C0"
            ],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom"
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} itens (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    function sortMenuItems(field) {
      if (sortField === field) {
        sortDirection *= -1;
      } else {
        sortField = field;
        sortDirection = 1;
      }

      filteredItems.sort((a, b) => {
        let valueA, valueB;
        if (field === 'preço') {
          valueA = a.preço;
          valueB = b.preço;
        } else if (field === 'avaliacao') {
          valueA = a.avaliacao || 0;
          valueB = b.avaliacao || 0;
        } else {
          valueA = a[field].toString().toLowerCase();
          valueB = b[field].toString().toLowerCase();
        }
        if (valueA < valueB) return -1 * sortDirection;
        if (valueA > valueB) return 1 * sortDirection;
        return 0;
      });

      currentPage = 1;
      renderMenuItems();
    }

    function filterMenuItems() {
      const searchTerm = document.getElementById("search-input").value.toLowerCase();
      const categoryFilter = document.getElementById("category-filter").value;

      filteredItems = cardapioData.filter(item => {
        const matchesSearch = item.nome.toLowerCase().includes(searchTerm);
        const matchesCategory = categoryFilter ? item.categoria === categoryFilter : true;
        return matchesSearch && matchesCategory;
      });

      currentPage = 1;
      renderMenuItems();
    }

    function renderMenuItems() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const itemsToShow = filteredItems.slice(start, end);

      const menuItems = document.getElementById("menu-items");
      menuItems.innerHTML = "";
      itemsToShow.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="p-2"><img src="${item.imagem}" alt="${item.nome}" class="max-w-[50px] rounded"></td>
          <td class="p-2">${item.nome}</td>
          <td class="p-2">${item.categoria}</td>
          <td class="p-2">R$ ${item.preço.toFixed(2)}</td>
          <td class="p-2">${item.avaliacao ? item.avaliacao.toFixed(1) : 'N/A'}</td>
          <td class="p-2">
            <button class="bg-[var(--secondary-color)] text-[var(--text-color)] px-3 py-1 rounded mr-2 hover:scale-105 transition" onclick="openEditModal(${item.id})"><i class="fas fa-edit mr-2"></i>Editar</button>
            <button class="bg-red-500 text-white px-3 py-1 rounded hover:scale-105 transition" onclick="openDeleteModal(${item.id})"><i class="fas fa-trash mr-2"></i>Excluir</button>
          </td>
        `;
        menuItems.appendChild(row);
      });

      const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
      document.getElementById("page-info").textContent = `Página ${currentPage} de ${totalPages}`;
      document.getElementById("prev-page").disabled = currentPage === 1;
      document.getElementById("next-page").disabled = currentPage === totalPages;
    }

    function changePage(direction) {
      currentPage += direction;
      renderMenuItems();
    }

    function openDeleteModal(itemId) {
      const item = cardapioData.find(i => i.id === itemId);
      if (item) {
        itemToDelete = itemId;
        document.getElementById("delete-item-name").textContent = item.nome;
        document.getElementById("delete-modal").classList.remove("hidden");
      }
    }

    function closeDeleteModal() {
      document.getElementById("delete-modal").classList.add("hidden");
      itemToDelete = null;
    }

    function confirmDelete() {
      if (itemToDelete !== null) {
        cardapioData = cardapioData.filter(item => item.id !== itemToDelete);
        filteredItems = filteredItems.filter(item => item.id !== itemToDelete);
        saveCardapioData();
        updateStatistics();
        renderMenuItems();
        closeDeleteModal();
      }
    }

    function exportCardapio(format) {
      if (format === 'json') {
        const dataStr = JSON.stringify(cardapioData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "cardapio.json";
        link.click();
      } else if (format === 'csv') {
        const headers = ['id', 'nome', 'categoria', 'preço', 'imagem', 'descrição', 'ingredientes', 'avaliacao', 'numAvaliacoes'];
        const rows = cardapioData.map(item => {
          return headers.map(field => {
            let value = item[field] || '';
            if (typeof value === 'string') {
              value = `"${value.replace(/"/g, '""')}"`;
            }
            return value;
          }).join(',');
        });
        const csvContent = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "cardapio.csv";
        link.click();
      }
    }

    function openTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-[var(--primary-color)]', 'text-white');
        btn.setAttribute('aria-selected', 'false');
      });

      const targetTab = document.getElementById(tabId);
      targetTab.classList.remove('hidden');

      const targetBtn = document.querySelector(`button[onclick="openTab('${tabId}')"]`);
      targetBtn.classList.add('active', 'bg-[var(--primary-color)]', 'text-white');
      targetBtn.setAttribute('aria-selected', 'true');
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
    }

    function logout() {
      localStorage.removeItem("adminToken");
      window.location.href = "admin.html";
    }

    function addSizeField() {
      const container = document.getElementById("sizes-container");
      const div = document.createElement("div");
      div.className = "flex gap-2 items-center";
      div.innerHTML = `
        <input type="text" placeholder="Tamanho (ex.: P)" class="size-name p-2 border rounded flex-1" required>
        <input type="number" placeholder="Preço (R$)" step="0.01" min="0" class="size-price p-2 border rounded flex-1" required>
        <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"><i class="fas fa-trash"></i></button>
      `;
      container.appendChild(div);
    }

    function addExtraField() {
      const container = document.getElementById("extras-container");
      const div = document.createElement("div");
      div.className = "flex gap-2 items-center";
      div.innerHTML = `
        <input type="text" placeholder="Extra (ex.: Azeitonas)" class="extra-name p-2 border rounded flex-1" required>
        <input type="number" placeholder="Preço (R$)" step="0.01" min="0" class="extra-price p-2 border rounded flex-1" required>
        <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"><i class="fas fa-trash"></i></button>
      `;
      container.appendChild(div);
    }

    function addEditSizeField() {
      const container = document.getElementById("edit-sizes-container");
      const div = document.createElement("div");
      div.className = "flex gap-2 items-center";
      div.innerHTML = `
        <input type="text" placeholder="Tamanho (ex.: P)" class="size-name p-2 border rounded flex-1" required>
        <input type="number" placeholder="Preço (R$)" step="0.01" min="0" class="size-price p-2 border rounded flex-1" required>
        <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"><i class="fas fa-trash"></i></button>
      `;
      container.appendChild(div);
    }

    function addEditExtraField() {
      const container = document.getElementById("edit-extras-container");
      const div = document.createElement("div");
      div.className = "flex gap-2 items-center";
      div.innerHTML = `
        <input type="text" placeholder="Extra (ex.: Azeitonas)" class="extra-name p-2 border rounded flex-1" required>
        <input type="number" placeholder="Preço (R$)" step="0.01" min="0" class="extra-price p-2 border rounded flex-1" required>
        <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"><i class="fas fa-trash"></i></button>
      `;
      container.appendChild(div);
    }

    function openEditModal(itemId) {
      const item = cardapioData.find(i => i.id === itemId);
      if (item) {
        document.getElementById("edit-item-id").value = item.id;
        document.getElementById("edit-item-name").value = item.nome;
        document.getElementById("edit-item-category").value = item.categoria;
        document.getElementById("edit-item-price").value = item.preço;
        document.getElementById("edit-item-image").value = item.imagem;
        document.getElementById("edit-image-preview").src = item.imagem;
        document.getElementById("edit-image-preview").style.display = "block";
        document.getElementById("edit-item-description").value = item.descrição;
        document.getElementById("edit-item-ingredients").value = item.ingredientes || '';

        const sizesContainer = document.getElementById("edit-sizes-container");
        sizesContainer.innerHTML = "";
        if (item.tamanhos) {
          Object.entries(item.tamanhos).forEach(([size, price]) => {
            const div = document.createElement("div");
            div.className = "flex gap-2 items-center";
            div.innerHTML = `
              <input type="text" value="${size}" placeholder="Tamanho (ex.: P)" class="size-name p-2 border rounded flex-1" required>
              <input type="number" value="${price}" placeholder="Preço (R$)" step="0.01" min="0" class="size-price p-2 border rounded flex-1" required>
              <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"><i class="fas fa-trash"></i></button>
            `;
            sizesContainer.appendChild(div);
          });
        }

        const extrasContainer = document.getElementById("edit-extras-container");
        extrasContainer.innerHTML = "";
        if (item.extrasDisponiveis) {
          Object.entries(item.extrasDisponiveis).forEach(([extra, price]) => {
            const div = document.createElement("div");
            div.className = "flex gap-2 items-center";
            div.innerHTML = `
              <input type="text" value="${extra}" placeholder="Extra (ex.: Azeitonas)" class="extra-name p-2 border rounded flex-1" required>
              <input type="number" value="${price}" placeholder="Preço (R$)" step="0.01" min="0" class="extra-price p-2 border rounded flex-1" required>
              <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"><i class="fas fa-trash"></i></button>
            `;
            extrasContainer.appendChild(div);
          });
        }

        document.getElementById("edit-modal").classList.remove("hidden");
      }
    }

    function closeModal() {
      document.getElementById("edit-modal").classList.add("hidden");
    }

    document.getElementById("add-item-form").addEventListener("submit", function(event) {
      event.preventDefault();
      addItem(false);
    });

    document.getElementById("edit-item-form").addEventListener("submit", function(event) {
      event.preventDefault();
      const itemId = parseInt(document.getElementById("edit-item-id").value);
      const itemIndex = cardapioData.findIndex(item => item.id === itemId);
      if (itemIndex !== -1) {
        const sizes = {};
        document.querySelectorAll("#edit-sizes-container .flex").forEach(div => {
          const sizeName = div.querySelector(".size-name").value;
          const sizePrice = parseFloat(div.querySelector(".size-price").value);
          if (sizeName && sizePrice >= 0) {
            sizes[sizeName] = sizePrice;
          }
        });

        const extras = {};
        document.querySelectorAll("#edit-extras-container .flex").forEach(div => {
          const extraName = div.querySelector(".extra-name").value;
          const extraPrice = parseFloat(div.querySelector(".extra-price").value);
          if (extraName && extraPrice >= 0) {
            extras[extraName] = extraPrice;
          }
        });

        cardapioData[itemIndex] = {
          ...cardapioData[itemIndex],
          nome: document.getElementById("edit-item-name").value,
          categoria: document.getElementById("edit-item-category").value,
          preço: parseFloat(document.getElementById("edit-item-price").value),
          imagem: document.getElementById("edit-item-image").value,
          descrição: document.getElementById("edit-item-description").value,
          ingredientes: document.getElementById("edit-item-ingredients").value,
          tamanhos: sizes,
          extrasDisponiveis: extras
        };

        filteredItems = filteredItems.map(item => item.id === itemId ? cardapioData[itemIndex] : item);
        saveCardapioData();
        updateStatistics();
        renderMenuItems();
        closeModal();
      }
    });

    function addItem(continueAdding) {
      const sizes = {};
      document.querySelectorAll("#sizes-container .flex").forEach(div => {
        const sizeName = div.querySelector(".size-name").value;
        const sizePrice = parseFloat(div.querySelector(".size-price").value);
        if (sizeName && sizePrice >= 0) {
          sizes[sizeName] = sizePrice;
        }
      });

      const extras = {};
      document.querySelectorAll("#extras-container .flex").forEach(div => {
        const extraName = div.querySelector(".extra-name").value;
        const extraPrice = parseFloat(div.querySelector(".extra-price").value);
        if (extraName && extraPrice >= 0) {
          extras[extraName] = extraPrice;
        }
      });

      const newItem = {
        id: cardapioData.length ? Math.max(...cardapioData.map(item => item.id)) + 1 : 1,
        nome: document.getElementById("item-name").value,
        categoria: document.getElementById("item-category").value,
        preço: parseFloat(document.getElementById("item-price").value),
        imagem: document.getElementById("item-image").value,
        descrição: document.getElementById("item-description").value,
        ingredientes: document.getElementById("item-ingredients").value,
        tamanhos: sizes,
        extrasDisponiveis: extras,
        avaliacao: null,
        numAvaliacoes: 0
      };

      cardapioData.push(newItem);
      filteredItems.push(newItem);
      saveCardapioData();
      updateStatistics();

      if (continueAdding) {
        document.getElementById("add-item-form").reset();
        document.getElementById("image-preview").style.display = "none";
        document.getElementById("sizes-container").innerHTML = "";
        document.getElementById("extras-container").innerHTML = "";
      } else {
        openTab("menu-tab");
      }
      renderMenuItems();
    }

    function addAndContinue() {
      addItem(true);
    }

    initializeDashboard();
  </script>
</body>
</html>